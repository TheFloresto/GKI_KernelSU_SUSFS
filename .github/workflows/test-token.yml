name: Test Release Token

on:
  workflow_dispatch:

jobs:
  test-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Test Token Permissions
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          echo "ğŸ” Testing token permissions..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº API
          echo "ğŸ“¡ Testing basic API access..."
          curl -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/user | jq '.login'
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
          echo "ğŸ“ Testing repository access..."
          curl -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }} | jq '.name, .permissions'
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ€ĞµĞ»Ğ¸Ğ·Ğ°Ğ¼
          echo "ğŸš€ Testing releases access..."
          curl -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/releases | jq 'length'
          
          # Ğ¢ĞµÑÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ‡ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸ĞºĞ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
          echo "âœ¨ Testing release creation..."
          RELEASE_RESPONSE=$(curl -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d '{
              "tag_name": "test-token-v1.0.0",
              "name": "Test Release - Delete Me",
              "body": "This is a test release to verify token permissions. Please delete.",
              "draft": true,
              "prerelease": true
            }')
          
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
          
          if [ "$RELEASE_ID" != "null" ] && [ "$RELEASE_ID" != "" ]; then
            echo "âœ… SUCCESS: Release created with ID: $RELEASE_ID"
            
            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ·
            echo "ğŸ—‘ï¸ Cleaning up test release..."
            curl -X DELETE \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID
            echo "âœ… Test release deleted"
          else
            echo "âŒ FAILED: Could not create release"
            echo "Response: $RELEASE_RESPONSE"
            exit 1
          fi
          
          echo "ğŸ‰ All token permissions are working correctly!"

      - name: Test GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          echo "ğŸ”§ Testing GitHub CLI..."
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° GitHub CLI ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
          if ! command -v gh &> /dev/null; then
            echo "ğŸ“¦ Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
          echo "ğŸ” Testing GitHub CLI authentication..."
          gh auth status
          
          # Ğ¢ĞµÑÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ»Ğ¸Ğ·Ğ° Ñ‡ĞµÑ€ĞµĞ· CLI
          echo "ğŸš€ Testing release creation via GitHub CLI..."
          gh release create test-cli-v1.0.0 \
            --title "Test CLI Release - Delete Me" \
            --notes "This is a test release via GitHub CLI. Please delete." \
            --draft \
            --prerelease
          
          echo "âœ… GitHub CLI release created successfully!"
          
          # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ·
          echo "ğŸ—‘ï¸ Cleaning up CLI test release..."
          gh release delete test-cli-v1.0.0 --yes
          
          echo "ğŸ‰ GitHub CLI test completed successfully!"
